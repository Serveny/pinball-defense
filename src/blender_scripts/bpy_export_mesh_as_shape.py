import os
from pathlib import Path
import bpy
from bpy.types import MeshPolygon, MeshVertex, MeshEdge
from mathutils import Vector, Quaternion, Euler
from math import sqrt

dir_name = Path(__file__).parent.parent
file_name = os.path.join(dir_name, "../../src/game/colliders.rs")

print("\n-------------------------------------\n")

mesh = bpy.context.active_object
if mesh.type != "MESH":
    raise Exception("Selected object is no mesh")
faces: list[MeshPolygon] = mesh.data.polygons
vertices: list[MeshVertex] = mesh.data.vertices
edges: list[MeshEdge] = mesh.data.edges

with open(file_name, "w") as file:
    file.write(
        """// File generated by blender script
use crate::prelude::*;

#[allow(clippy::approx_constant)]
pub fn create_collider() -> Collider {
    let faces = vec![
    """
    )
    for face in faces:
        file.write("        (")

        # Position
        pos = face.center
        file.write(f"Vec3::new({pos.x:f}, {pos.z:f}, {-pos.y:f}), ")

        # Rotation
        norm: Vector = face.normal
        quat: Quaternion = Vector((norm.x, norm.z, -norm.y)).to_track_quat("Z", "Y")
        file.write(f"Quat::from_xyzw({quat.x:f}, {quat.y:f}, {quat.z:f}, {quat.w:f}), ")
        print(f"{quat.to_euler()=}")

        # Size of face
        verts: list[Vector] = [vertices[key].co for key in face.vertices]
        width = (verts[1] - verts[2]).length / 2
        height = (verts[1] - verts[0]).length / 2
        if height >= 0.1:
            width, height = height, width
        # print(f"{width=}, {height=}")
        file.write(f"Collider::cuboid({height:f}, {width:f}, {0.0001:f})")
        file.write("),\n")
    file.write("    ];")
    file.write("    Collider::compound(faces)")
    file.write("}")
